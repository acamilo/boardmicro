<html>
<meta name=viewport content="width=device-width, initial-scale=1">
<style>
  body
  {
    margin: 0;
    padding: 0;
    width: 0;
  }
  img
  {
    margin: 0;
    padding: 0;
    width: 100%;
    height: auto;
  }
</style>
  
<script src="js/avrcore.js"></script>
<script src="js/elfcore.js"></script>
  
<body id="layout">
<div id="sources">
<input text="this" type="file" id="file"/>
</div>
<canvas id="screen"></canvas>
<div id="portB" style="display:table;">
<canvas style="width:1px;"></canvas>
<canvas id="B0"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="B1"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="B2"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="B3"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="B4"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="B5"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="B6"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="B7"></canvas>
</div>
<hr style="margin:0">
<div id="portC" style="display:table;">
<canvas style="width:1px;"></canvas>
<canvas id="C0"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="C1"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="C2"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="C3"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="C4"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="C5"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="C6"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="C7"></canvas>
</div>
<hr style="margin:0">
<div id="portD" style="display:table">
<canvas style="width:1px;"></canvas>
<canvas id="D0"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="D1"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="D2"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="D3"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="D4"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="D5"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="D6"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="D7"></canvas>
</div>
<hr style="margin:0">
<div id="portE" style="display:table">
<canvas style="width:1px;"></canvas>
<canvas id="E0"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="E1"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="E2"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="E3"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="E4"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="E5"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="E6"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="E7"></canvas>
</div>
<hr style="margin:0">
<div id="portF" style="display:table">
<canvas style="width:1px;"></canvas>
<canvas id="F0"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="F1"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="F2"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="F3"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="F4"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="F5"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="F6"></canvas>
<canvas style="width:1px;"></canvas>
<canvas id="F7"></canvas>
</div>
<input style="width:0;" type="search" id="uart" size="33"/>
</body>
  
<script src="js/tft_spi_driver.js"></script>
<details id="debug">
<summary>Debug</summary>
<button onClick="doDebugCommand();">(gdb)</button>
<input type="search" size="15" id="gdb" value="" onkeydown="filterRelevantKeypress()"/>
<font id="gdbshell"></font>
<br/>
<font>Batch Instructions 1 - 300000</font>
<br/>
<input id="batch" onchange="batchSize=this.value" style="width: 99%" type="range" min="1" max="300000" value="1024">
<br/>
<font>Batch Delay 0 - 1000ms</font>
<br/>
<input id="delay" onchange="batchDelay=this.value" style="width: 99%" type="range" min="0" max="1000" value="0">
<br/>
<font>ADC Value 0 - 1023</font>
<br/>
<input id="adc" onchange="adcValue=this.value" style="width: 99%" type="range" min="0" max="1023" value="42">
<br/>
<input type="checkbox" onchange="forceOptimizationEnabled=this.checked"><font>Disable SPI Port Animation</font>
<br/>
<input type="checkbox" onchange="disableUARTInterrupt=this.checked"><font>Disable UART Interrupt</font>
<br/>
</details>
<script> 
  
  // Replacement for lib.js
  
  function normalize(value, align)
  {
    var normal_value = Math.floor(value);
    return normal_value % align == 0 ? normal_value: normal_value - (normal_value % align) ;
  }

  // Platform specific
  var target = "atmega32u4";
  var num_ports = 5
  var port_width = 8;

  var B0 = document.getElementById('B0');
  var B1 = document.getElementById('B1');
  var B2 = document.getElementById('B2');
  var B3 = document.getElementById('B3');
  var B4 = document.getElementById('B4');
  var B5 = document.getElementById('B5');
  var B6 = document.getElementById('B6');
  var B7 = document.getElementById('B7');
  var C6 = document.getElementById('C6');
  var C7 = document.getElementById('C7');
  var D0 = document.getElementById('D0');
  var D1 = document.getElementById('D1');
  var D2 = document.getElementById('D2');
  var D3 = document.getElementById('D3');
  var D4 = document.getElementById('D4');
  var D5 = document.getElementById('D5');
  var D6 = document.getElementById('D6');
  var D7 = document.getElementById('D7');
  var E2 = document.getElementById('E2');
  var E6 = document.getElementById('E6');
  var F0 = document.getElementById('F0');
  var F1 = document.getElementById('F1');
  var F4 = document.getElementById('F4');
  var F5 = document.getElementById('F5');
  var F6 = document.getElementById('F6');
  var F7 = document.getElementById('F7');
  
  var max_width = 320;
  var max_height = 480;
  
  var width = screen.width > max_width ? max_width: screen.width;
  var height = screen.height > max_height ? max_height: screen.height;
  var layout = document.getElementById('layout');
  var screen_canvas = document.getElementById("screen");
  var uart = document.getElementById("uart");
  var debug = document.getElementById("debug");
  var sources = document.getElementById("sources");
  var file_input = document.getElementById('file');
  var red_color = "#FF0000";
  var green_color = "#00FF00"
  var default_color = "#626269";
  var screen_buffer = document.createElement("canvas");
  var gdb_window = document.getElementById("gdb");
  var result_window = document.getElementById("gdbshell");
  var nokiaScreen = target == "atmega328";
  screen_buffer.width = nokiaScreen ? 84: 160;
  screen_buffer.height = nokiaScreen ? 48: 128; 
  var scale = width/screen_buffer.width;
  var commandHistory = [];
  var historyIndex = -1;
  
  // TODO cache references to pin objects
  
  function initScreen() 
  {
      screen_canvas.width = width;
      screen_canvas.height = scale*screen_buffer.height;
      return screen_canvas.height;
  }
  
  function initPort(port_id, port_height) 
  {
      var pin = document.getElementById(port_id);
      pin.width = normalize(width/port_width, port_width)-1;
      var device_width = (pin.width*port_width) + port_width;
      if(device_width < width)
      {
          pin.width += normalize((width-device_width)/port_width, 2);
      }
      pin.height = port_height;
      fillCanvas(pin, default_color);
  }

  function initLastPin(port_id, port_height)
  {
     initPort(port_id, port_height);
     var pin = document.getElementById(port_id);
     var device_width = (pin.width*port_width)+port_width;
     pin.width += width-device_width;
  }

  function initPorts(port_height) 
  {
     initPort("B0",port_height);
     initPort("B1",port_height);
     initPort("B2",port_height);
     initPort("B3",port_height);
     initPort("B4",port_height);
     initPort("B5",port_height);
     initPort("B6",port_height);
     initLastPin("B7",port_height);
    
     initPort("C0",port_height);
     initPort("C1",port_height);
     initPort("C2",port_height);
     initPort("C3",port_height);
     initPort("C4",port_height);
     initPort("C5",port_height);
     initPort("C6",port_height);
     initLastPin("C7",port_height);
    
     initPort("D0",port_height);
     initPort("D1",port_height);
     initPort("D2",port_height);
     initPort("D3",port_height);
     initPort("D4",port_height);
     initPort("D5",port_height);
     initPort("D6",port_height);
     initLastPin("D7",port_height);
    
     initPort("E0",port_height);
     initPort("E1",port_height);
     initPort("E2",port_height);
     initPort("E3",port_height);
     initPort("E4",port_height);
     initPort("E5",port_height);
     initPort("E6",port_height);
     initLastPin("E7",port_height);
    
     initPort("F0",port_height);
     initPort("F1",port_height);
     initPort("F2",port_height);
     initPort("F3",port_height);
     initPort("F4",port_height);
     initPort("F5",port_height);
     initPort("F6",port_height);
     initLastPin("F7",port_height);
  }
  
  function setupActivePorts() 
  {
      fillCanvas(B0, red_color);
      fillCanvas(B1, red_color);
      fillCanvas(B2, red_color);
      fillCanvas(B3, red_color);
      fillCanvas(B4, red_color);
      fillCanvas(B5, red_color);
      fillCanvas(B6, red_color);
      fillCanvas(B7, red_color);
      fillCanvas(C6, red_color);
      fillCanvas(C7, red_color);
      fillCanvas(D0, red_color);
      fillCanvas(D1, red_color);
      fillCanvas(D2, red_color);
      fillCanvas(D3, red_color);
      fillCanvas(D4, red_color);
      fillCanvas(D5, red_color);
      fillCanvas(D6, red_color);
      fillCanvas(D7, red_color);
      fillCanvas(E2, red_color);
      fillCanvas(E6, red_color);
      fillCanvas(F0, red_color);
      fillCanvas(F1, red_color);
      fillCanvas(F4, red_color);
      fillCanvas(F5, red_color);
      fillCanvas(F6, red_color);
      fillCanvas(F7, red_color);
  }
  
  function setupInactivePorts()
  {
      fillCanvas(C0, default_color);
      fillCanvas(C1, default_color);
      fillCanvas(C2, default_color);
      fillCanvas(C3, default_color);
      fillCanvas(C4, default_color);
      fillCanvas(C5, default_color);
      fillCanvas(E0, default_color);
      fillCanvas(E1, default_color);
      fillCanvas(E3, default_color);
      fillCanvas(E4, default_color);
      fillCanvas(E5, default_color);
      fillCanvas(E7, default_color);
      fillCanvas(F2, default_color);
      fillCanvas(F3, default_color);
  }


  function initFileInput()
  {
      file_input.addEventListener('change', function(evt)
      {
        var file = file_input.files[0];
        if(!file) 
        {
          alert('Intel Hex File Required');
          return;
        }
        var reader = new FileReader();
        reader.onloadend = function(evt) 
        {
          if(evt.target.readyState == FileReader.DONE) 
          {
            var bytes = evt.target.result;
            if( bytes.charCodeAt(0) == 0x7f && bytes[1] == 'E' && bytes[2] == 'L' && bytes[3] == 'F' )
            {
              intelhex = getHexFromElf(bytes);
              buildFrameInfo();
              buildLineInfo();
            }else{
              intelhex = evt.target.result;
            }
            loadMemory(intelhex);
            engineInit();
            exec();
          }
        };
        reader.readAsBinaryString(file.slice(0, file.size));
      }, false);
  }
  
  function fillCanvas(canvas, color)
  {
      var context = canvas.getContext('2d');
      switch(color)
      {
          case "red":
              color = "#FF0000";
              break;
          case "green":
              color = "#00FF00";
              break;
          case "black":
              color = "#000000";
              break;
      }
      var imgData = context.getImageData(0,0,canvas.width,canvas.height);
      var cursor = canvas.width*canvas.height*4;
      while(cursor-=4)
      {
        imgData.data[cursor]   = parseInt(color.substr(1,2),16);
        imgData.data[cursor+1] = parseInt(color.substr(3,2),16);
        imgData.data[cursor+2] = parseInt(color.substr(5),16);
        imgData.data[cursor+3] = 0xFF;
      }
      imgData.data[cursor]   = parseInt(color.substr(1,2),16);
      imgData.data[cursor+1] = parseInt(color.substr(3,2),16);
      imgData.data[cursor+2] = parseInt(color.substr(5),16);
      imgData.data[cursor+3] = 0xFF;
      context.putImageData(imgData, 0, 0);
  }
  
  function refreshScreen()
  {
      var context = screen_canvas.getContext('2d');
      context.scale(scale,scale);
      context.drawImage(screen_buffer, 0, 0);
      context.scale(1/scale,1/scale);
  }
  
  function pinNumberToPinObject(pin_number)
  {
    var pin = null;
    switch(pin_number)
    {
      case 0:
        pin = B0;
        break;
      case 1:
        pin = B1;
        break;
      case 2:
        pin = B2;
        break;
      case 3:
        pin = B3;
        break;
      case 4:
        pin = B4;
        break;
      case 5:
        pin = B5;
        break;
      case 6:
        pin = B6;
        break;
      case 7:
        pin = B7;
        break;
      case 14:
        pin = C6;
        break;
      case 15:
        pin = C7;
        break;
      case 16:
        pin = D0;
        break;
      case 17:
        pin = D1;
        break;
      case 18:
        pin = D2;
        break;
      case 19:
        pin = D3;
        break;
      case 20:
        pin = D4;
        break;
      case 21:
        pin = D5;
        break;
      case 22:
        pin = D6;
        break;
      case 23:
        pin = D7;
        break;
      case 26:
        pin = E6;
        break;
      case 30:
        pin = E7;
        break;
      case 32:
        pin = F0;
        break;
      case 33:
        pin = F1;
        break;
      case 36:
        pin = F4;
        break;
      case 37:
        pin = F5;
        break;
      case 38:
        pin = F6;
        break;
      case 39:
        pin = F7;
        break;
    }
    
    return pin;
  }
  
  function popPortBuffer(queue, port)
  {
      if(!optimizationEnabled && !(forceOptimizationEnabled && (port == spipinport1*8 || port == spipinport2*8)))
      {
        var pin = null;
        // Disable all port pins
        for(i = 0; i < bitsPerPort; i++)
        {
          pin = pinNumberToPinObject(parseInt(i + port));
          if(pin)
          {
            //IsGreen?
            var data = pin.getContext('2d').getImageData(0, 0, 1, 1).data[1];
            if(data == 0xFF)
            {
              fillCanvas(pin, red_color);
            }
          }
        }
        queue = queue.shift();
        // Enable selected port pins
        for(i = 0; i < bitsPerPort; i++) 
        {
           if(parseInt(queue) & 1 << i)
           {
             pin = pinNumberToPinObject(parseInt(i + port));
             if(pin)
             {
               fillCanvas(pin, green_color);
             }
           }
        }
      }
      else{
          queue.shift();
      }
  }
  
  function uartWrite(data){
      uart.value.length == uartBufferLength - 1 && (uart.value = "");
      uart.value += String.fromCharCode(data);
  }
  
  function drawPixel(x, y, color)
  {
      if( x > screen_buffer.width-1 || y > screen_buffer.height-1 )
      {
        return;
      }
      var context = screen_buffer.getContext('2d');
      var imgData = context.getImageData(x,y,1,1);
      imgData.data[0] = parseInt(color.substr(1,2),16);
      imgData.data[1] = parseInt(color.substr(3,2),16);
      imgData.data[2] = parseInt(color.substr(5),16);
      imgData.data[3] = 0xFF;
      context.putImageData(imgData, x, y);
  }
  
  function fillScreen(color)
  {
      for(var y = 0; y < screen_buffer.height; y++)
      {
        for(var x = 0; x < screen_buffer.width; x++)
        {
          drawPixel( x, y, color );
        }
      }
  }
  
  function handleBreakpoint(address)
  {
      var index = softBreakpoints.indexOf(parseInt(address, 16)-flashStart+2);
      if(index >= 0)
      {
        alert("Breakpoint at 0x" + softBreakpoints[index].toString(16));
      }
  }
  
  function filterRelevantKeypress()
  {
      switch(event.which)
      {
        case 13:
            doDebugCommand();
            break;
        case 38:
            gdb_window.value = historyIndex >= 0 ?
            commandHistory[historyIndex--]: "";
            break;
      }
  }

  function doDebugCommand()
  {
      var command = gdb_window.value;
      commandHistory.push(command);
      historyIndex = commandHistory.length-1;
      handleDebugCommandString(command);
      gdb_window.value = "";
      gdb_window.focus();
  }

  function setDebugResult(result)
  {
      result_window.textContent = result;
  }

  // Essential layout functions
  layout.style.width = width;
  uart.style.width = width;
  var uart_height = normalize(height/25, 2);
  uart.style.height = uart_height;
  debug.style.background = default_color;
  debug.style.width = width;
  sources.style.background = default_color;
  var sources_height = normalize(height/21, 2);
  sources.style.height = sources_height;
  var screen_height = initScreen();
  fillCanvas(screen_canvas,"black");
  fillCanvas(screen_buffer,"black");
  var port_height = normalize((height-screen_height-uart_height-sources_height)/num_ports, 2);
  initPorts(port_height);
  setupActivePorts();
  setupInactivePorts();
  initFileInput();

</script>
  
</html>
